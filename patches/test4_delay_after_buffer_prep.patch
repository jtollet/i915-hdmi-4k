From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jerome Tollet <jerome.tollet@gmail.com>
Date: Mon, 13 Jan 2025 17:55:00 +0100
Subject: [PATCH] drm/i915/hdmi: Test 4 - Add delay after buffer preparation

This is a test patch to investigate Ville's feedback about the timing
of SCDC scrambling setup. This test adds a 150ms delay just after
preparing the HDMI DDI buffers to determine if the scrambler needs time
between buffer preparation and signal configuration.

Test sequence:
1. Configure SCDC scrambling
2. Prepare HDMI DDI buffers
3. **[150ms delay HERE]**
4. Enable D2D link
5. Set signal levels
6. Display WA #1143 (if applicable)
7. Power up lanes
8. Enable DDI buffer
9. Poll for scrambling status

If this test WORKS: The scrambler needs time between buffer preparation
and D2D/signal setup.
If this test FAILS: The delay may need to be even earlier (after SCDC
config) or the issue is more complex than simple timing.

Note: This is the earliest reasonable point for the delay in the
hardware initialization sequence, as it comes right after SCDC
configuration but before any PHY/signal operations.

Suggested-by: Ville Syrjälä <ville.syrjala@linux.intel.com>
Signed-off-by: Jerome Tollet <jerome.tollet@gmail.com>
---
 drivers/gpu/drm/i915/display/intel_ddi.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/gpu/drm/i915/display/intel_ddi.c b/drivers/gpu/drm/i915/display/intel_ddi.c
index 123456789abc..234567890bcd 100644
--- a/drivers/gpu/drm/i915/display/intel_ddi.c
+++ b/drivers/gpu/drm/i915/display/intel_ddi.c
@@ -3423,6 +3423,15 @@ static void intel_ddi_enable_hdmi(struct intel_atomic_state *state,
 	if (has_buf_trans_select(display))
 		hsw_prepare_hdmi_ddi_buffers(encoder, crtc_state);
 
+	/* Test 4: Delay after buffer preparation to allow scrambler stabilization */
+	if (crtc_state->hdmi_scrambling) {
+		drm_dbg_kms(display->drm,
+			    [CONNECTOR:%d:%s] Test 4: Adding 150ms delay after buffer preparationn,
+			    connector->base.id, connector->name);
+		msleep(150);
+	}
+
 	/* e. Enable D2D Link for C10/C20 Phy */
 	mtl_ddi_enable_d2d(encoder);
 
-- 
2.43.0
